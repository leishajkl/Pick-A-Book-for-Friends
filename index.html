<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pick-A-Bookï½œæŠ½æ›¸æ±ºç­–å¡</title>

<style>
  :root{--bg:#0f1115;--panel:#14161c;--text:#eaeaf0;--muted:rgba(234,234,240,.75);--border:#2a2d35;}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;background:var(--bg);color:var(--text);}
  .topbar{position:fixed;top:0;left:0;right:0;height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:var(--bg);border-bottom:1px solid #222;z-index:9999}
  .brand{font-weight:800;letter-spacing:.2px}
  .langToggle{display:flex;gap:6px;padding:4px;border-radius:999px;border:1px solid #333;background:#1a1c22}
  .langToggle a{text-decoration:none;color:var(--text);padding:6px 10px;border-radius:999px;font-size:13px;font-weight:700}
  .langToggle a.active{background:#333}
  main{padding:88px 16px 40px;max-width:920px;margin:auto}
  h1{margin:0 0 8px;font-size:32px}
  .sub{margin:0 0 18px;color:var(--muted)}
  .card{border:1px solid var(--border);border-radius:14px;padding:18px;margin-bottom:16px;background:var(--panel)}
  button{background:#2a2d35;border:1px solid #3a3d45;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  button:hover{background:#343844}
  input{margin:10px 0}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:13px;white-space:pre-wrap}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-block;padding:2px 8px;border:1px solid #3a3d45;border-radius:999px;color:var(--muted);font-size:12px}
</style>
</head>

<body>
<div class="topbar">
  <div class="brand">Pick-A-Book</div>
  <div class="langToggle">
    <a href="index.html" class="active">ä¸­æ–‡</a>
    <a href="index-en.html">EN</a>
  </div>
</div>

<main>
  <h1>æŠ½æ›¸æ±ºç­–å¡</h1>
  <p class="sub">ç”¨ Goodreads æ›¸å–®åšæ±ºç­–å¡ã€‚åŒ¯å…¥å¾ŒæŠ½ä¸€æœ¬ï¼›åªæœ‰ä½ çœŸçš„è¦è®€çš„é‚£æœ¬æ‰éœ€è¦ä¹‹å¾Œé€²ä¸€æ­¥ Confirmï¼ˆè‹¥ä½ æ¥å›å®Œæ•´ç‰ˆæœ¬ï¼‰ã€‚</p>

  <div class="card">
    <h3 style="margin:0 0 8px">1ï½œä¸Šå‚³ Goodreads CSV</h3>
    <div class="row">
      <input type="file" id="csvInput" accept=".csv">
      <span class="pill">æ”¯æ´ï¼što-read / want to read / want-to-read / wanttoread</span>
    </div>
    <div id="importInfo" class="mono" style="color:var(--muted);margin-top:8px"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">2ï½œæŠ½ä¸€æœ¬æ›¸</h3>
    <button id="drawBtn">æŠ½æ›¸</button>
    <div id="result" style="margin-top:12px;font-weight:800;font-size:18px"></div>
  </div>
</main>

<script>
  const STORAGE_KEY = "pickabook_books_v1";

  function norm(s){ return (s ?? "").toString().trim().toLowerCase(); }

  // RFC4180-ish CSV parser: supports quotes, commas, and newlines inside quotes.
  function parseCSV(text){
    const rows = [];
    let row = [];
    let field = "";
    let i = 0;
    let inQuotes = false;

    while (i < text.length){
      const c = text[i];

      if (inQuotes){
        if (c === '"'){
          const next = text[i+1];
          if (next === '"'){ field += '"'; i += 2; continue; } // escaped quote
          inQuotes = false; i++; continue;
        } else {
          field += c; i++; continue;
        }
      } else {
        if (c === '"'){ inQuotes = true; i++; continue; }
        if (c === ','){ row.push(field); field=""; i++; continue; }
        if (c === '\r'){
          // ignore, handle by \n
          i++; continue;
        }
        if (c === '\n'){
          row.push(field); field="";
          rows.push(row);
          row = [];
          i++; continue;
        }
        field += c; i++; continue;
      }
    }
    // last field
    row.push(field);
    rows.push(row);

    // remove possible trailing empty row
    if (rows.length && rows[rows.length-1].length === 1 && rows[rows.length-1][0] === ""){
      rows.pop();
    }
    return rows;
  }

  function rowsToObjects(rows){
    if (!rows.length) return [];
    const headers = rows[0].map(h => (h ?? "").toString().trim());
    const out = [];
    for (let r=1; r<rows.length; r++){
      const cols = rows[r];
      // skip totally empty lines
      if (cols.every(x => (x ?? "").toString().trim() === "")) continue;
      const o = {};
      for (let c=0; c<headers.length; c++){
        o[headers[c]] = (cols[c] ?? "");
      }
      out.push(o);
    }
    return out;
  }

  function getField(row, possibleNames){
    for (const name of possibleNames){
      if (Object.prototype.hasOwnProperty.call(row, name)) return row[name];
    }
    // fallback: case-insensitive match
    const keys = Object.keys(row);
    for (const name of possibleNames){
      const target = name.toLowerCase();
      const hit = keys.find(k => k.toLowerCase() === target);
      if (hit) return row[hit];
    }
    return "";
  }

  function isTBR(row){
    const ex = norm(getField(row, ["Exclusive Shelf","ExclusiveShelf"]));
    const shelvesRaw = norm(getField(row, ["Bookshelves","Book Shelves","bookshelves"]));

    // shelves can be comma separated; normalize by replacing punctuation with spaces
    const shelves = shelvesRaw.replace(/[;|]/g, ",");
    const hasShelf = (kw) => shelves.includes(kw);

    return (
      ex === "to-read" ||
      hasShelf("to-read") ||
      hasShelf("want to read") ||
      hasShelf("want-to-read") ||
      hasShelf("wanttoread")
    );
  }

  function bookFromRow(row){
    const title = getField(row, ["Title","Book Title"]);
    const author = getField(row, ["Author","Author l-f","Author LF","Author(s)"]);
    return { title: (title ?? "").toString().trim(), author: (author ?? "").toString().trim() };
  }

  function summarizeExclusiveShelves(rows){
    const counts = new Map();
    for (const row of rows){
      const ex = norm(getField(row, ["Exclusive Shelf","ExclusiveShelf"]));
      if (!ex) continue;
      counts.set(ex, (counts.get(ex) ?? 0) + 1);
    }
    // top 6
    const sorted = [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,6);
    return sorted.map(([k,v])=>`${k}: ${v}`).join(" | ");
  }

  document.getElementById("csvInput").addEventListener("change", (e)=>{
    const f = e.target.files[0];
    if(!f) return;

    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const raw = reader.result;
        const rows = parseCSV(raw);
        const objs = rowsToObjects(rows);

        const total = objs.length;
        const tbr = [];
        for (const row of objs){
          if (isTBR(row)){
            const b = bookFromRow(row);
            if (b.title) tbr.push(b);
          }
        }

        localStorage.setItem(STORAGE_KEY, JSON.stringify(tbr));

        const exSummary = summarizeExclusiveShelves(objs);
        document.getElementById("importInfo").textContent =
`è®€åˆ°è³‡æ–™åˆ—ï¼š${total}
ç¬¦åˆå¾…è®€ï¼ˆto-read / want-to-read / want to readï¼‰ï¼š${tbr.length}
Exclusive Shelf çµ±è¨ˆï¼ˆå‰å¹¾ç¨®ï¼‰ï¼š${exSummary || "(ç„¡è³‡æ–™)"}
`;
        alert(`å·²åŒ¯å…¥ ${tbr.length} æœ¬å¾…è®€æ›¸`);
      }catch(err){
        console.error(err);
        alert("è§£æ CSV å¤±æ•—ï¼šå¯èƒ½æª”æ¡ˆæ ¼å¼ä¸æ¨™æº–ã€‚è«‹æŠŠ CSV å¦å­˜æˆ UTF-8 å†è©¦ä¸€æ¬¡ã€‚");
      }
    };
    reader.readAsText(f);
  });

  document.getElementById("drawBtn").addEventListener("click", ()=>{
    const books = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    if(!books.length){
      alert("å°šæœªåŒ¯å…¥å¾…è®€æ›¸å–®ï¼ˆæˆ–åŒ¯å…¥å¾Œçµæœç‚º 0ï¼‰ã€‚");
      return;
    }
    const b = books[Math.floor(Math.random()*books.length)];
    document.getElementById("result").textContent = `ğŸ“– ${b.title} â€” ${b.author || "Unknown"}`;
  });
</script>
</body>
</html>
